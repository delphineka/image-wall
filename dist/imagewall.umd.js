(function(y,v){typeof exports=="object"&&typeof module<"u"?v(exports):typeof define=="function"&&define.amd?define(["exports"],v):(y=typeof globalThis<"u"?globalThis:y||self,v(y.ImageWall={}))})(this,(function(y){"use strict";class v{container;images;debug;modal;inner;imgEls;captionEl;prevBtn;nextBtn;closeBtn;currentIndex=0;activeLayer=0;loadId=0;touchStartX=0;touchStartY=0;touchEndX=0;touchEndY=0;constructor(s){this.container=s.container,this.images=s.images??[],(!this.images||this.images.length===0)&&(this.images=Array.from(this.container.querySelectorAll(":scope > picture, :scope > img"))),this.debug=!!s.debug,this.modal=document.createElement("div"),this.modal.className="lightbox-modal",this.modal.style.display="none",this.inner=document.createElement("div"),this.inner.className="lightbox-inner";const i=document.createElement("img"),h=document.createElement("img");i.className="lightbox-img",h.className="lightbox-img",i.classList.remove("visible"),h.classList.remove("visible"),this.imgEls=[i,h],this.captionEl=document.createElement("div"),this.captionEl.className="lightbox-caption",this.prevBtn=document.createElement("button"),this.prevBtn.type="button",this.prevBtn.className="lightbox-prev",this.nextBtn=document.createElement("button"),this.nextBtn.type="button",this.nextBtn.className="lightbox-next",this.closeBtn=document.createElement("button"),this.closeBtn.type="button",this.closeBtn.className="lightbox-close",this.inner.append(i,h,this.captionEl,this.prevBtn,this.nextBtn,this.closeBtn),this.modal.append(this.inner),document.body.append(this.modal),this.modal.addEventListener("click",e=>{e.target===this.modal&&this.hide()}),this.prevBtn.addEventListener("click",()=>this.prev()),this.nextBtn.addEventListener("click",()=>this.next()),i.addEventListener("click",e=>this.imageClickHandler(e)),h.addEventListener("click",e=>this.imageClickHandler(e)),i.addEventListener("contextmenu",e=>e.preventDefault()),h.addEventListener("contextmenu",e=>e.preventDefault()),this.closeBtn.addEventListener("click",()=>this.hide()),document.addEventListener("keydown",e=>{if(this.modal.classList.contains("open"))switch(e.key){case"ArrowLeft":e.preventDefault(),this.prev();break;case"ArrowRight":e.preventDefault(),this.next();break;case"Escape":e.preventDefault(),this.hide();break}}),this.modal.addEventListener("touchstart",e=>{e.touches.length===1&&(this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY)}),this.modal.addEventListener("touchend",e=>{e.changedTouches.length===1&&(this.touchEndX=e.changedTouches[0].clientX,this.touchEndY=e.changedTouches[0].clientY,this.handleSwipe())}),this.container.addEventListener("click",e=>{const b=e.target,n=this.images.find(f=>f===b||f.contains(b));if(!n)return;const u=this.images.indexOf(n);u>=0&&this.show(u)})}handleSwipe(){const s=this.touchEndX-this.touchStartX,i=this.touchEndY-this.touchStartY,h=Math.abs(s),e=Math.abs(i);Math.max(h,e)<40||(h>e?s>0?this.prev():this.next():this.hide())}imageClickHandler=s=>{const h=s.currentTarget.getBoundingClientRect();s.clientX-h.left<h.width/2?this.prev():this.next()};show(s){if(s<0||s>=this.images.length)return;this.currentIndex=s;const i=this.images[s],h=i.dataset.src,e=i.dataset.caption??"";if(!h){this.debug&&console.warn("LightBox: clicked element missing data-src",i);return}this.modal.classList.add("open"),this.modal.style.removeProperty("display");const b=this.imgEls[this.activeLayer],n=this.imgEls[1-this.activeLayer];this.debug&&console.debug(`LightBox: show index ${s}, src=${h}, caption="${e}"`);const u=++this.loadId;n.onload=null,n.onerror=null,n.classList.remove("visible"),n.src="",n.onload=()=>{if(u!==this.loadId)return;n.classList.add("visible"),b.classList.remove("visible"),this.debug&&console.debug("LightBox: image loaded successfully",n),this.activeLayer=1-this.activeLayer,e?(this.captionEl.textContent=e,this.captionEl.classList.add("visible")):(this.captionEl.textContent="",this.captionEl.classList.remove("visible"));const f=(this.currentIndex+1)%this.images.length,l=this.images[f].dataset.src;if(l){const E=new Image;E.src=l,this.debug&&console.debug(`LightBox: preloading next image ${f} (${l})`)}},n.onerror=()=>{this.debug&&console.warn("LightBox: failed to load",h)},n.src=h}hide(){this.modal.classList.remove("open"),this.captionEl.classList.remove("visible"),this.imgEls.forEach(s=>s.classList.remove("visible")),this.loadId++}next(){this.show((this.currentIndex+1)%this.images.length)}prev(){this.show((this.currentIndex-1+this.images.length)%this.images.length)}}class k extends EventTarget{lightbox=null;container;images=[];opts;resizeTimer=null;constructor(s,i={}){if(super(),!s)throw new Error("ImageWall: container is required");this.container=s,this.images=Array.from(this.container.querySelectorAll(":scope > picture, :scope > img")),this.opts={rowHeight:i.rowHeight??180,gap:i.gap??6,lastRowAlign:i.lastRowAlign??"center",enableLightbox:i.enableLightbox??!0,debounceMs:i.debounceMs??120,debug:i.debug??!1},this.container.style.position=this.container.style.position||"relative",this.container.style.width="100%",this.layout(),this.container.classList.add("image-wall-initialized"),window.addEventListener("resize",()=>{this.resizeTimer&&window.clearTimeout(this.resizeTimer),this.resizeTimer=window.setTimeout(()=>{this.layout(),this.resizeTimer=null},this.opts.debounceMs)}),this.opts.enableLightbox&&(this.lightbox=new v({container:this.container,images:this.images,debug:this.opts.debug}))}refresh(){this.layout()}rebuild(){this.images=Array.from(this.container.querySelectorAll(":scope > picture, :scope > img")),this.layout(),this.opts.enableLightbox&&this.lightbox&&(this.lightbox.images=this.images)}async layout(){if(!this.images.length){this.container.style.height="0px";return}const s=await Promise.all(this.images.map(async t=>{const o=t.tagName.toLowerCase()==="img"?t:t.querySelector("img");if(!o)throw new Error("ImageWall: each item must contain an <img>");const{width:d,height:r}=await this.loadImageNaturalSize(o),a=d&&r?d/r:1;return{el:t,aspect:a,naturalW:d,naturalH:r,src:o.currentSrc||o.src||""}})),i=this.container.getBoundingClientRect(),h=getComputedStyle(this.container),e=parseFloat(h.paddingLeft)||0,b=parseFloat(h.paddingRight)||0,n=Math.max(1,Math.floor(i.width-e-b));this.opts.debug&&(console.debug("[ImageWall] containerInner:",n),console.debug("[ImageWall] items:",s.map(t=>({src:t.src,aspect:+t.aspect.toFixed(3)}))));const u=this.opts.gap,f=this.opts.rowHeight,L=[];let l=[],E=0;for(const t of s)if(l.push(t),E+=t.aspect,E*f+u*(l.length-1)>=n){const d=(n-u*(l.length-1))/E,r=l.map(a=>a.aspect*d);L.push({items:l.slice(),floatWidths:r,rowHFloat:d,stretch:!0}),l=[],E=0}if(l.length)if(this.opts.lastRowAlign==="justify"){const o=l.reduce((a,m)=>a+m.aspect,0),d=(n-u*(l.length-1))/o,r=l.map(a=>a.aspect*d);L.push({items:l.slice(),floatWidths:r,rowHFloat:d,stretch:!0})}else{const o=l.map(d=>d.aspect*f);L.push({items:l.slice(),floatWidths:o,rowHFloat:f,stretch:!1})}this.opts.debug&&console.debug("[ImageWall] rowsTemp:",L.map((t,o)=>({idx:o,count:t.items.length,stretch:t.stretch,rowH:Math.round(t.rowHFloat)})));const I=[];for(const t of L){const o=t.items.length,d=u*Math.max(0,o-1);if(t.stretch){const r=n-d,a=t.floatWidths.map(c=>Math.floor(c)),m=t.floatWidths.map((c,g)=>({idx:g,frac:c-a[g]}));let p=a.reduce((c,g)=>c+g,0),x=r-p;if(x<0){let c=-x;for(let g=a.length-1;g>=0&&c>0;g--){const M=Math.min(Math.max(0,a[g]-1),c);M>0&&(a[g]-=M,c-=M)}p=a.reduce((g,M)=>g+M,0),x=Math.max(0,r-p)}m.sort((c,g)=>g.frac-c.frac);const B=new Array(o).fill(0);for(let c=0;c<x;c++)B[m[c%o].idx]++;const W=a.map((c,g)=>c+B[g]),w=W.reduce((c,g)=>c+g,0);w!==r&&(W[W.length-1]+=r-w);const T=Math.max(1,Math.round(t.rowHFloat));I.push({items:t.items,widths:W,height:T,stretch:!0})}else{const r=t.floatWidths.map(m=>Math.max(1,Math.round(m))),a=Math.max(1,Math.round(t.rowHFloat));I.push({items:t.items,widths:r,height:a,stretch:!1})}}if(this.opts.lastRowAlign!=="justify"&&I.length>0){const t=I[I.length-1],o=t.widths.length,d=u*Math.max(0,o-1),r=t.widths.reduce((a,m)=>a+m,0)+d;r<n?t.stretch=!1:t.stretch=!0,this.opts.debug&&console.debug("[ImageWall] post-check last rowInnerWidth:",r,"containerInner:",n,"stretch:",t.stretch)}this.images.forEach(t=>{t.style.position="",t.style.left="",t.style.top="",t.style.width="",t.style.height="",t.style.margin="";const o=t.tagName.toLowerCase()==="img"?t:t.querySelector("img");o&&(o.style.display="block",o.style.width="100%",o.style.height="100%",o.style.objectFit="cover")});let S=0;for(const t of I){const o=t.widths.length,d=u*Math.max(0,o-1),a=t.widths.reduce((p,x)=>p+x,0)+d;let m=0;if(!t.stretch&&a<n){const p=this.opts.lastRowAlign;p==="center"?m=Math.round((n-a)/2):p==="right"?m=Math.max(0,n-a):m=0}else m=0;for(let p=0;p<t.items.length;p++){const x=t.items[p],B=t.widths[p],W=t.height,w=x.el;w.style.position="absolute",w.style.left=`${m}px`,w.style.top=`${S}px`,w.style.width=`${B}px`,w.style.height=`${W}px`,w.style.margin="0",m+=B+u}S+=t.height+u}this.container.style.height=`${Math.max(0,S-u)}px`,this.dispatchEvent(new Event("layout")),this.opts.debug&&console.debug("[ImageWall] layout complete, total height:",this.container.style.height)}loadImageNaturalSize(s){return new Promise((i,h)=>{if(!s.src){i({width:1,height:1});return}if(s.complete&&s.naturalWidth){i({width:s.naturalWidth,height:s.naturalHeight});return}const e=new Image;e.onload=()=>i({width:e.naturalWidth,height:e.naturalHeight}),e.onerror=()=>{const b=s.naturalWidth||s.width||1,n=s.naturalHeight||s.height||1;i({width:b,height:n})},e.src=s.currentSrc||s.src})}}y.ImageWall=k,y.LightBox=v,Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})}));
